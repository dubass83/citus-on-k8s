# Certificate-Based Authentication for Citus Inter-Node Communication

This document explains the certificate-based authentication implementation for secure Citus inter-node communication.

## Overview

Starting from version **1.4.0**, the cluster uses **certificate-based authentication** for Citus inter-node communication instead of storing passwords in `citus.node_conninfo`. This significantly improves security by eliminating password exposure in PostgreSQL configuration.

## How It Works

### Architecture

1. **All nodes share the same SSL certificate** (distributed via Kubernetes Secret)
2. **Certificate has dual purpose**: Server authentication + Client authentication
3. **pg_hba.conf** configured with `cert` authentication method for postgres user
4. **pg_ident.conf** maps any certificate CN to the postgres user
5. **citus.node_conninfo** uses SSL without password

### Authentication Flow

```
Coordinator → Worker Connection:
1. Coordinator presents client certificate (server.crt)
2. Worker verifies certificate against CA (ca.crt)
3. Worker checks pg_hba.conf: "hostssl all postgres ... cert clientcert=verify-ca map=cnmap"
4. Worker applies pg_ident map: certificate CN → postgres user
5. Connection established without password
```

## Configuration Details

### entrypoint.sh Changes

```yaml
postgresql:
  parameters:
    # SSL configuration
    ssl: 'on'
    ssl_ca_file: /etc/ssl/certs/postgresql/ca.crt
    ssl_cert_file: /etc/ssl/certs/postgresql/server.crt
    ssl_key_file: /etc/ssl/certs/postgresql/server.key
    
    # Citus inter-node connection (NO PASSWORD!)
    citus.node_conninfo: 'sslrootcert=/etc/ssl/certs/postgresql/ca.crt 
                          sslkey=/etc/ssl/certs/postgresql/server.key 
                          sslcert=/etc/ssl/certs/postgresql/server.crt 
                          sslmode=verify-ca'
  
  pg_hba:
    - local all all trust
    # Certificate authentication for postgres user (used by Citus)
    - hostssl all postgres 0.0.0.0/0 cert clientcert=verify-ca map=cnmap
    # MD5 authentication for other users (backward compatibility)
    - hostssl all all 0.0.0.0/0 md5
    # Replication uses MD5
    - hostssl replication standby ${POD_IP}/16 md5
  
  pg_ident:
    # Map any certificate CN to postgres user
    - cnmap /^.*$ postgres
```

### What Changed from Previous Versions

**Before (v1.3.0 and earlier):**
```yaml
citus.node_conninfo: '... user=postgres password=${POSTGRES_PASSWORD}'
```
- ❌ Password visible in `SHOW citus.node_conninfo;`
- ❌ Password stored in Patroni DCS
- ❌ Security risk if someone gains database access

**After (v1.4.0+):**
```yaml
citus.node_conninfo: '... sslcert=... sslkey=... sslmode=verify-ca'
```
- ✅ No password in configuration
- ✅ Certificate-based authentication
- ✅ More secure for production

## Certificate Requirements

### Current Certificate Configuration

The certificate generated by `scripts/generate-ssl-certs.sh` includes:

```
Subject: CN=*.citusdemo.default.svc.cluster.local, O=Citus, C=US
X509v3 Extended Key Usage: 
    TLS Web Server Authentication, TLS Web Client Authentication
X509v3 Subject Alternative Name:
    DNS:*.citusdemo.default.svc.cluster.local
    DNS:*.citusdemo-*.default.svc.cluster.local
    ...
```

**Key Requirements:**
1. ✅ `extendedKeyUsage` must include `clientAuth` (TLS Web Client Authentication)
2. ✅ Certificate must be signed by the CA (ca.crt)
3. ✅ All nodes must have access to the same certificates

### Verifying Your Certificates

```bash
# Check if certificate has clientAuth
openssl x509 -in certs/server.crt -noout -text | grep -A 1 "Extended Key Usage"

# Should show:
# X509v3 Extended Key Usage: 
#     TLS Web Server Authentication, TLS Web Client Authentication
```

## Upgrade Guide

### For New Deployments

New deployments automatically use certificate-based authentication. No action needed.

### For Existing Deployments (v1.3.0 → v1.4.0+)

**Prerequisites:**
- SSL must be enabled (`ssl.enabled: true` in values.yaml)
- SSL certificates must exist (see [SSL_SETUP.md](SSL_SETUP.md))

**Steps:**

#### 1. Verify Current SSL Setup

```bash
# Check if SSL is enabled
kubectl exec -it citusstage-0-0 -- psql -U postgres -d citus -c "SHOW ssl;"

# Check certificate files exist
kubectl exec -it citusstage-0-0 -- ls -la /etc/ssl/certs/postgresql/

# Should show: ca.crt, server.crt, server.key
```

#### 2. Verify Certificate Has clientAuth

```bash
# From your local machine where certificates are generated
cd certs/
openssl x509 -in server.crt -noout -text | grep "TLS Web Client Authentication"

# Should return: TLS Web Client Authentication
```

If your certificate doesn't have `clientAuth`, regenerate it:

```bash
# Regenerate certificates with updated script
./scripts/generate-ssl-certs.sh

# Update Kubernetes secret
kubectl create secret generic citusstage-ssl-certs \
  --from-file=ca.crt=certs/ca.crt \
  --from-file=server.crt=certs/server.crt \
  --from-file=server.key=certs/server.key \
  --namespace=citus-cluster-stage \
  --dry-run=client -o yaml | kubectl apply -f -
```

#### 3. Rebuild Docker Image

```bash
# Build new image with updated entrypoint.sh
docker build -f Dockerfile.citus -t ghcr.io/dubass83/citus:1.4.0 .

# Push to registry
docker push ghcr.io/dubass83/citus:1.4.0
```

#### 4. Upgrade Deployment

```bash
# Update image version
helm upgrade citusstage ./helm/citus-cluster \
  -f helm/citus-cluster/values.stg.yaml \
  --set image.tag=1.4.0 \
  --reuse-values

# Rolling restart all pods
kubectl rollout restart statefulset citusstage-0
kubectl rollout restart statefulset citusstage-1

# Monitor rollout
kubectl rollout status statefulset citusstage-0
kubectl rollout status statefulset citusstage-1
```

#### 5. Verify Certificate Authentication

```bash
# Connect to coordinator
kubectl exec -it citusstage-0-0 -- bash

# Check citus.node_conninfo (should NOT contain password)
psql -U postgres -d citus -c "SHOW citus.node_conninfo;"

# Should show something like:
# sslrootcert=/etc/ssl/certs/postgresql/ca.crt sslkey=... (NO PASSWORD)

# Check pg_hba.conf
psql -U postgres -d citus -c "SELECT * FROM pg_hba_file_rules WHERE type = 'hostssl' AND database = '{all}';"

# Should show cert authentication rule for postgres user

# Test worker connectivity
psql -U postgres -d citus -c "SELECT * FROM citus_check_cluster_node_health();"

# All workers should return "true"
```

#### 6. Test Database Creation

```bash
# Try creating a new database and adding workers
kubectl exec -it citusstage-0-0 -- psql -U postgres <<EOF
CREATE DATABASE test_cert_auth;
\c test_cert_auth
CREATE EXTENSION citus;
SELECT * FROM citus_add_node('citusstage-1', 5432);
SELECT * FROM citus_get_active_worker_nodes();
\q
EOF

# Should succeed without "no password supplied" errors
```

## Troubleshooting

### Error: "no pg_hba.conf entry for host"

```
ERROR: connection to the remote node postgres@citusstage-1:5432 failed
DETAIL: no pg_hba.conf entry for host "10.x.x.x", user "postgres", database "dbname", SSL on
```

**Cause**: Certificate authentication rule not in pg_hba.conf

**Fix**: Verify entrypoint.sh has the cert rule and restart pods:

```bash
kubectl rollout restart statefulset citusstage-0
kubectl rollout restart statefulset citusstage-1
```

### Error: "certificate authentication failed"

```
ERROR: certificate authentication failed for user "postgres"
```

**Cause 1**: Certificate doesn't have `clientAuth` in extendedKeyUsage

**Fix**: Regenerate certificates using the updated `generate-ssl-certs.sh` script

**Cause 2**: pg_ident map not configured

**Fix**: Check entrypoint.sh has `pg_ident` section

### Error: "could not access private key file"

```
ERROR: could not access private key file "/etc/ssl/certs/postgresql/server.key": Permission denied
```

**Cause**: Init container didn't fix permissions

**Fix**: Check init container logs:
```bash
kubectl logs citusstage-0-0 -c fix-permissions
```

Ensure permissions are: `0600` for `.key` files, `0644` for `.crt` files

### Rollback to Password Authentication

If certificate authentication doesn't work, you can temporarily rollback:

```bash
# Edit entrypoint.sh, restore password in citus.node_conninfo:
citus.node_conninfo: '... user=postgres password=${PATRONI_SUPERUSER_PASSWORD}'

# Change pg_hba.conf back to md5:
- hostssl all all 0.0.0.0/0 md5

# Rebuild and redeploy
docker build -f Dockerfile.citus -t ghcr.io/dubass83/citus:1.3.1-rollback .
docker push ghcr.io/dubass83/citus:1.3.1-rollback

helm upgrade citusstage ./helm/citus-cluster \
  --set image.tag=1.3.1-rollback \
  --reuse-values

kubectl rollout restart statefulset citusstage-0 citusstage-1
```

## Security Benefits

### What's Protected

1. **No Password in Configuration**
   - `SHOW citus.node_conninfo;` doesn't reveal password
   - Patroni DCS doesn't store password

2. **Certificate Verification**
   - Each connection verifies certificate chain
   - Man-in-the-middle attacks prevented

3. **Mutual TLS (mTLS)**
   - Server authenticates to client (standard SSL)
   - Client authenticates to server (certificate auth)

### What's Still Needed

1. **Protect Certificate Files**
   - Kubernetes Secret stores certificates
   - Init container sets proper permissions
   - Never commit `.key` files to git

2. **Certificate Rotation**
   - Certificates expire after 3 years (1095 days)
   - Plan certificate rotation before expiry
   - Update secret and restart pods

3. **Access Control**
   - Limit who can access pods (`kubectl exec`)
   - Limit who can read Kubernetes Secrets
   - Use RBAC for secret access

## Certificate Rotation

When certificates approach expiration:

```bash
# 1. Generate new certificates
./scripts/generate-ssl-certs.sh

# 2. Update secret
kubectl create secret generic citusstage-ssl-certs \
  --from-file=ca.crt=certs/ca.crt \
  --from-file=server.crt=certs/server.crt \
  --from-file=server.key=certs/server.key \
  --namespace=citus-cluster-stage \
  --dry-run=client -o yaml | kubectl apply -f -

# 3. Rolling restart (pods will pick up new certificates)
kubectl rollout restart statefulset citusstage-0
kubectl rollout restart statefulset citusstage-1

# 4. Verify
kubectl exec -it citusstage-0-0 -- openssl x509 -in /etc/ssl/certs/postgresql/server.crt -noout -dates
```

## Comparison: Password vs Certificate Authentication

| Aspect | Password Auth (v1.3.0) | Certificate Auth (v1.4.0+) |
|--------|----------------------|---------------------------|
| Security | ⚠️ Password in config | ✅ No password exposed |
| Setup Complexity | ✅ Simple | ⚠️ Requires SSL setup |
| Performance | ✅ Fast | ✅ Fast (minimal overhead) |
| Audit Trail | ⚠️ Limited | ✅ Certificate-based logs |
| Compliance | ⚠️ May not meet standards | ✅ Industry best practice |
| Maintenance | ✅ None | ⚠️ Certificate rotation needed |

## See Also

- [SSL_SETUP.md](SSL_SETUP.md) - SSL/TLS certificate generation and configuration
- [DATABASE_MANAGEMENT.md](DATABASE_MANAGEMENT.md) - Creating additional databases
- [DATABASE_MANAGEMENT_TROUBLESHOOTING.md](DATABASE_MANAGEMENT_TROUBLESHOOTING.md) - Authentication troubleshooting
