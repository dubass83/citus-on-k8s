name: Helm Chart Lint and Test

on:
  push:
    branches:
      - main
      - master
    paths:
      - "helm/**"
      - ".github/workflows/helm-lint.yml"
  pull_request:
    paths:
      - "helm/**"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "v3.13.0"

      - name: Add Helm repos (if needed)
        run: |
          # Add any required Helm repositories here
          # helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Lint Helm chart
        run: |
          helm lint ./helm/citus-cluster
          helm lint ./helm/citus-cluster --values ./helm/citus-cluster/values.yaml
          helm lint ./helm/citus-cluster --values ./helm/citus-cluster/values.stg.yaml

      - name: Template Helm chart (default values)
        run: |
          helm template test ./helm/citus-cluster > /dev/null

      - name: Template Helm chart (staging values)
        run: |
          helm template test ./helm/citus-cluster \
            --values ./helm/citus-cluster/values.stg.yaml > /dev/null

      - name: Template Helm chart (SSL enabled)
        run: |
          helm template test ./helm/citus-cluster \
            --set ssl.enabled=true \
            --set ssl.mode=verify-ca > /dev/null

      - name: Template Helm chart (persistent volumes)
        run: |
          helm template test ./helm/citus-cluster \
            --set storage.persistentVolume.enabled=true > /dev/null

      - name: Install Pluto
        run: |
          VERSION=5.20.2
          curl -L "https://github.com/FairwindsOps/pluto/releases/download/v${VERSION}/pluto_${VERSION}_linux_amd64.tar.gz" | tar xz
          chmod +x pluto
          sudo mv pluto /usr/local/bin/

      - name: Check for deprecated APIs
        run: |
          pluto detect-helm --directory helm/citus-cluster --target-versions k8s=v1.28.0

      - name: Summary
        if: always()
        run: |
          echo "### Helm Lint Results ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Helm chart validations passed!" >> $GITHUB_STEP_SUMMARY

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "v3.13.0"

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: citus-test
          wait: 120s

      - name: Build Docker image
        run: |
          docker build -f Dockerfile.citus -t patroni-citus-k8s:test .
          kind load docker-image patroni-citus-k8s:test --name citus-test

      - name: Install Helm chart
        run: |
          helm install citus-test ./helm/citus-cluster \
            --set image.repository=patroni-citus-k8s \
            --set image.tag=test \
            --set image.pullPolicy=Never \
            --set coordinator.replicas=1 \
            --set workers[0].replicas=1 \
            --set workers[1].replicas=1 \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl get pods -l cluster-name=citus-test
          kubectl get statefulsets
          kubectl get services

      - name: Wait for pods to be ready
        run: |
          kubectl wait --for=condition=ready pod \
            -l cluster-name=citus-test \
            --timeout=5m

      - name: Check Patroni cluster status
        run: |
          kubectl exec -it citus-test-0-0 -- patronictl list

      - name: Test PostgreSQL connectivity
        run: |
          kubectl exec -it citus-test-0-0 -- \
            psql -U postgres -d citus -c "SELECT version();"

      - name: Verify Citus cluster
        run: |
          kubectl exec -it citus-test-0-0 -- \
            psql -U postgres -d citus -c "SELECT * FROM citus_get_active_worker_nodes();"

      - name: Collect logs on failure
        if: failure()
        run: |
          kubectl get pods -A
          kubectl get events --sort-by='.lastTimestamp'
          kubectl logs -l cluster-name=citus-test --tail=100

      - name: Summary
        if: always()
        run: |
          echo "### Helm Chart Test Results ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Chart successfully deployed and tested in kind cluster!" >> $GITHUB_STEP_SUMMARY
