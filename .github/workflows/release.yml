name: Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install semantic-release
        run: |
          npm install -g semantic-release@23 \
            @semantic-release/git@10 \
            @semantic-release/changelog@6 \
            @semantic-release/github@10 \
            @semantic-release/exec@6

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Get version
        id: version
        run: |
          if [ -f VERSION.txt ]; then
            VERSION=$(cat VERSION.txt)
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "Version: ${VERSION}"
          else
            echo "No version file created (no release needed)"
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        if: steps.version.outputs.version != ''
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: steps.version.outputs.version != ''
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        if: steps.version.outputs.version != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.citus
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}:latest
          platforms: linux/amd64,linux/arm64

      - name: Package and push Helm chart
        if: steps.version.outputs.version != ''
        run: |
          # Update chart version
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" helm/citus-cluster/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: ${{ steps.version.outputs.version }}/" helm/citus-cluster/Chart.yaml

          # Package chart
          helm package helm/citus-cluster

          # Push to GitHub Packages (OCI registry)
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin
          helm push citus-cluster-${{ steps.version.outputs.version }}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.version.outputs.version }}" != "" ]; then
            echo "### Release Created ðŸš€" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Docker Image:** ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Helm Chart:** oci://ghcr.io/${{ github.repository_owner }}/charts/citus-cluster:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### No Release Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No version bump needed based on commit messages." >> $GITHUB_STEP_SUMMARY
          fi
